<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Parameters</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

</head>

<body class="container mt-4">

    <p>Simulation for {{ system_name }}</p>
    <p><a href="/logout">Logout</a> <a href="/dashboard">Dashboard</a></p>

    <h2>Simulation Parameters</h2>
    <form id="simulation-form" action="{{ url_for('simulate') }}" method="POST">
        <input type="hidden" name="system_id" value="{{ system_id }}">
        <!-- Module Count -->
        <label for="module_count" class="form-label">Number of Solar Panels:</label>
        <input type="number" class="form-control" name="module_count" value="{{ module_count }}" required>

        <h4 class="mt-4">Battery Parameters</h4>
        <label class="form-label">Usable Energy (kWh):</label>
        <input type="number" step="0.01" class="form-control" name="batt_usable_energy_kwh"
            value="{{ batt_usable_energy_kwh }}" required>

        <label class="form-label">Charge Efficiency (0-1):</label>
        <input type="number" step="0.01" class="form-control" name="batt_charge_eff" value="{{ batt_charge_eff }}"
            required>

        <label class="form-label">Discharge Efficiency (0-1):</label>
        <input type="number" step="0.01" class="form-control" name="batt_discharge_eff" value="{{ batt_discharge_eff }}"
            required>

        <label class="form-label">Max C-Rate: (assuming 125V) max amp = maxC * (usable_energy_kwh/1000) / 125</label>
        <input type="number" step="0.01" class="form-control" name="batt_max_c_rate" value="{{ batt_max_c_rate }}"
            required>

        <h4 class="mt-4">Grid Parameters</h4>

        <!-- Time Inputs -->
        <div class="row mt-3">
            <!-- Left Column: Start Times -->
            <div class="col-md-6">
                <label class="form-label">Weekday On-Peak Start:</label>
                <input type="time" class="form-control" name="grid_weekday_on_peak_start"
                    value="{{ grid_weekday_on_peak_start }}" required>

                <label class="form-label">Weekend On-Peak Start:</label>
                <input type="time" class="form-control" name="grid_weekend_on_peak_start"
                    value="{{ grid_weekend_on_peak_start }}" required>
            </div>

            <!-- Right Column: End Times -->
            <div class="col-md-6">
                <label class="form-label">Weekday On-Peak End:</label>
                <input type="time" class="form-control" name="grid_weekday_on_peak_end"
                    value="{{ grid_weekday_on_peak_end }}" required>

                <label class="form-label">Weekend On-Peak End:</label>
                <input type="time" class="form-control" name="grid_weekend_on_peak_end"
                    value="{{ grid_weekend_on_peak_end }}" required>
            </div>
        </div>


        <hr>
        <!-- Cost and Payment Inputs -->
        <div class="row mt-3">
            <!-- Left Column: Off-Peak -->
            <div class="col-md-6">
                <label class="form-label">Weekday Off-Peak Cost ($/kWh):</label>
                <input type="number" step="0.01" class="form-control" name="grid_weekday_off_peak_cost_per_kwh"
                    value="{{ grid_weekday_off_peak_cost_per_kwh }}" required>

                <label class="form-label">Weekend Off-Peak Cost ($/kWh):</label>
                <input type="number" step="0.01" class="form-control" name="grid_weekend_off_peak_cost_per_kwh"
                    value="{{ grid_weekend_off_peak_cost_per_kwh }}" required>
            </div>

            <!-- Right Column: On-Peak -->
            <div class="col-md-6">
                <label class="form-label">Weekday On-Peak Cost ($/kWh):</label>
                <input type="number" step="0.01" class="form-control" name="grid_weekday_on_peak_cost_per_kwh"
                    value="{{ grid_weekday_on_peak_cost_per_kwh }}" required>

                <label class="form-label">Weekend On-Peak Cost ($/kWh):</label>
                <input type="number" step="0.01" class="form-control" name="grid_weekend_on_peak_cost_per_kwh"
                    value="{{ grid_weekend_on_peak_cost_per_kwh }}" required>
            </div>
        </div>


        <!-- Credits -->
        <div class="row">
            <div class="col-md-6">
                <label for="grid_weekday_off_peak_gen_pay_per_kwh" class="form-label">Weekday Off-Peak Gen Credit
                    ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekday_off_peak_gen_pay_per_kwh"
                    name="grid_weekday_off_peak_gen_pay_per_kwh" value="{{ grid_weekday_off_peak_gen_pay_per_kwh }}">
            </div>
            <div class="col-md-6">
                <label for="grid_weekday_on_peak_gen_pay_per_kwh" class="form-label">Weekday On-Peak Gen Credit
                    ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekday_on_peak_gen_pay_per_kwh"
                    name="grid_weekday_on_peak_gen_pay_per_kwh" value="{{ grid_weekday_on_peak_gen_pay_per_kwh }}">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="grid_weekday_off_peak_creditable_per_kwh" class="form-label">Weekday Off-Peak Credit
                    Redeemable ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekday_off_peak_creditable_per_kwh"
                    name="grid_weekday_off_peak_creditable_per_kwh"
                    value="{{ grid_weekday_off_peak_creditable_per_kwh }}">
            </div>
            <div class="col-md-6">
                <label for="grid_weekday_on_peak_creditable_per_kwh" class="form-label">Weekday On-Peak Credit
                    Redeemable ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekday_on_peak_creditable_per_kwh"
                    name="grid_weekday_on_peak_creditable_per_kwh"
                    value="{{ grid_weekday_on_peak_creditable_per_kwh }}">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="grid_weekend_off_peak_gen_pay_per_kwh" class="form-label">Weekend Off-Peak Gen Credit
                    ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekend_off_peak_gen_pay_per_kwh"
                    name="grid_weekend_off_peak_gen_pay_per_kwh" value="{{ grid_weekend_off_peak_gen_pay_per_kwh }}">
            </div>
            <div class="col-md-6">
                <label for="grid_weekend_on_peak_gen_pay_per_kwh" class="form-label">Weekend On-Peak Gen Credit
                    ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekend_on_peak_gen_pay_per_kwh"
                    name="grid_weekend_on_peak_gen_pay_per_kwh" value="{{ grid_weekend_on_peak_gen_pay_per_kwh }}">
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label for="grid_weekend_off_peak_creditable_per_kwh" class="form-label">Weekend Off-Peak Credit
                    Redeemable ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekend_off_peak_creditable_per_kwh"
                    name="grid_weekend_off_peak_creditable_per_kwh"
                    value="{{ grid_weekend_off_peak_creditable_per_kwh }}">
            </div>
            <div class="col-md-6">
                <label for="grid_weekend_on_peak_creditable_per_kwh" class="form-label">Weekend On-Peak Credit
                    Redeemable ($/kWh):</label>
                <input type="number" step="any" class="form-control" id="grid_weekend_on_peak_creditable_per_kwh"
                    name="grid_weekend_on_peak_creditable_per_kwh"
                    value="{{ grid_weekend_on_peak_creditable_per_kwh }}">
            </div>
        </div>

        <hr>
        <!-- Start and End Datetime Fields -->
        <div class="row mt-4">
            <div class="col-md-6">
                <label for="start_datetime" class="form-label">Start Datetime:</label>
                <input type="datetime-local" class="form-control" id="start_datetime" name="start_datetime"
                    value="{{ start_datetime }}">
            </div>
            <div class="col-md-6">
                <label for="end_datetime" class="form-label">End Datetime:</label>
                <input type="datetime-local" class="form-control" id="end_datetime" name="end_datetime"
                    value="{{ end_datetime }}">
            </div>
        </div>

        <div class="text-center mt-4">
            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary mt-3">Simulate</button>
        </div>
    </form>

    <!-- Results Section -->
    <div id="error_txt" class="mt-4">
        {% if err_msg %}
        <h3>Issue running simulation:</h3>

        <pre> {{ err_msg }} </pre>

        {% endif %}
    </div>
    <div id="results" class="mt-4">
        {% if results %}
        <h3>Simulation Results:</h3>

        <div id="energy_bar"></div>

        <div id="aggregated_percentages"></div>


        {% endif %}
    </div>

    <script>
        // Plot of results
        // Parse the results dictionary passed from Flask
        const results = JSON.parse('{{ results | safe }}');

        const energy_categories = ['Consumption', 'Imported', 'Export', 'Solar', 'Battery discharge']
        const energy_values_peak = [results.sum_consumption_peak_kwh, results.sum_import_peak_kwh, results.sum_export_peak_kwh, results.sum_produced_peak_kwh, results.sum_battery_peak_kwh]
        const energy_values_offpeak = [results.sum_consumption_offpeak_kwh, results.sum_import_offpeak_kwh, results.sum_export_offpeak_kwh, results.sum_produced_offpeak_kwh, results.sum_battery_offpeak_kwh]

        const cost_categories = ['Import cost', 'Credit earned', 'Without solar'];
        const cost_values_peak = [results.sum_import_peak_cost, results.sum_import_peak_credits, results.sum_import_peak_cost_no_solar]
        const cost_values_offpeak = [results.sum_import_nopeak_cost, results.sum_import_nopeak_credits, results.sum_import_nopeak_cost_no_solar]


        // Energy (kWh) - left y-axis
        const energyOffPeak = {
            x: energy_categories,
            y: energy_values_offpeak,
            name: 'Off-Peak',
            type: 'bar',
            marker: { color: '#AEDFF7' },
            yaxis: 'y',
            hovertemplate: '%{y} kWh<extra></extra>'
        };

        const energyPeak = {
            x: energy_categories,
            y: energy_values_peak,
            name: 'Peak',
            type: 'bar',
            marker: { color: '#007ACC' },
            yaxis: 'y',
            hovertemplate: '%{y} kWh<extra></extra>'
        };

        // Cost ($) - right y-axis
        const costOffPeak = {
            x: cost_categories,
            y: cost_values_offpeak,
            name: 'Off-Peak',
            type: 'bar',
            marker: { color: '#FCD5B4' },
            yaxis: 'y2',
            hovertemplate: '$%{y:.2f} <extra></extra>'
        };

        const costPeak = {
            x: cost_categories,
            y: cost_values_peak,
            name: 'Peak',
            type: 'bar',
            marker: { color: '#E69138' },
            yaxis: 'y2',
            hovertemplate: '$%{y:.2f} <extra></extra>'
        };

        const creditsRemain = {
            x: ["Credits remaining"],
            y: [results.credits_remaining],
            name: 'Final',
            type: 'bar',
            marker: { color: '#BFD641' },
            yaxis: 'y2',
            hovertemplate: '$%{y:.2f} <extra></extra>',
            offsetgroup: 'independent'  // Ensures it's not stacked with other bars
        }

        const data = [energyOffPeak, energyPeak, costOffPeak, costPeak, creditsRemain];

        const layout = {
            title: 'Energy Usage and Costs (Peak vs Off-Peak)',
            barmode: 'stack',
            xaxis: {
                title: { text: 'Metrics'},
                tickangle: -45
            },
            yaxis: {
                title: { text: 'Energy (kWh)'},
                rangemode: 'tozero'
            },
            yaxis2: {
                title: { text: 'Cost ($)'},
                overlaying: 'y',
                side: 'right',
                rangemode: 'tozero'
            },
            legend: {
                title: { text: 'Time of Use' },
                x: 1.05,
                orientation: 'v'
            },
            margin: { b: 100 },
            hovermode: 'x unified' // Enables unified hover labels
        };


        // Render the chart in the div
        Plotly.newPlot('energy_bar', data, layout, { responsive: true });

        // Aggregated Percentages Plot
        const percentage_categories = ['Grid Dependence', 'Solar Savings', 'Battery Depleted', 'Battery Saturated'];
        const percentage_values = [
            results.grid_dependence,
            results.percent_solar_savings,
            results.batt_depleted_percentage,
            results.batt_saturated_percentage
        ];

        const percentagesBar = {
            x: percentage_values,
            y: percentage_categories,
            type: 'bar',
            orientation: 'h',
            marker: { color: '#6BAED6' },
            hovertemplate: (d) => {
                if (d.y === 'Solar Savings') {
                    return '%{x:.2f}%<br>Savings: $' + results.solar_savings_dollars.toFixed(2) + '<extra></extra>';
                }
                return '%{x:.2f}%<extra></extra>';
            }
        };

        const percentagesLayout = {
            title: { text: 'Aggregated Percentages'},
            xaxis: {
                title: { text: 'Percentage (%)' },
                rangemode: 'tozero'
            },
            yaxis: {
                //title: { text: 'Metrics' }
            },
            margin: { l: 150 },
            hovermode: 'y unified'
        };

        Plotly.newPlot('aggregated_percentages', [percentagesBar], percentagesLayout, { responsive: true });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
</body>

</html>
